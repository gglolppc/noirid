{% extends "base.html" %}

{% block title %}{{ product.title }} · NOIRID{% endblock %}

{% block content %}
<div class="relative bg-[#050505] selection:bg-white selection:text-black min-h-screen text-zinc-300 pb-28 lg:pb-0">
  <nav class="absolute top-8 left-6 md:left-12 z-40">
    <a href="/catalog" class="group flex items-center gap-3 text-sm md:text-base uppercase tracking-wider text-zinc-400 hover:text-white transition-colors">
      <span class="transition-transform group-hover:-translate-x-1">←</span> Back to Catalog
    </a>
  </nav>

  <section class="pt-24 md:pt-32 pb-32 px-6 md:px-12">
    <div class="mx-auto max-w-7xl">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-12 lg:gap-20">

        <!-- LEFT: PREVIEW (sticky) -->
        <div id="product-preview" class="lg:col-span-7">
          <div class="lg:sticky lg:top-32">
            <div class="relative aspect-[4/5] rounded-3xl md:rounded-4xl border border-white/5 bg-[#080808] overflow-hidden group shadow-2xl">
              <div class="pointer-events-none absolute inset-0 z-10 shadow-[inset_0_0_160px_rgba(0,0,0,0.7)]"></div>

              <div id="previewBadge"
                     class="hidden absolute z-20 rounded-full bg-white/5 backdrop-blur-lg border border-white/10 text-white/80 uppercase tracking-wider
                            left-3 top-3 px-3 py-1.5 text-[11px] max-w-[70%] truncate
                            md:left-8 md:top-8 md:px-6 md:py-3 md:text-sm md:max-w-none">
                  Live Preview
                </div>

              <div id="previewSpinner" class="hidden flex absolute inset-0 z-30 items-center justify-center bg-black/30 backdrop-blur-sm">
                <div class="flex flex-col items-center gap-6">
                  <div class="w-16 h-0.5 bg-white/20 overflow-hidden relative">
                    <div class="absolute inset-0 bg-white translate-x-[-100%] animate-[shimmer_1.5s_infinite]"></div>
                  </div>
                  <span class="text-sm uppercase tracking-wider text-white font-light">
                    Refining Your Design
                  </span>
                </div>
              </div>

              <!-- GALLERY -->
              <div id="productGallery" class="flex flex-col h-full w-full p-10 md:p-14 gap-6">

                <!-- MAIN -->
                <div class="relative flex-1 flex items-center justify-center">
                  {% if product.images %}
                    <img
                      id="mainProductImg"
                      src="{{ product.images[0].url }}"
                      alt="{{ product.title }}"
                      class="gallery-img h-full w-full object-contain group-hover:scale-105"
                    />
                  {% else %}
                    <img
                      id="mainProductImg"
                      src="/static/img/placeholder.webp"
                      alt="{{ product.title }}"
                      class="gallery-img h-full w-full object-contain group-hover:scale-105"
                    />
                  {% endif %}

                  <!-- premium sheen overlay -->
                  <div id="gallerySheen" class="pointer-events-none absolute inset-0 opacity-0 transition-opacity duration-700
                       bg-[radial-gradient(circle_at_30%_20%,rgba(255,255,255,0.08),transparent_45%)]"></div>

                  {% if product.images and (product.images|length > 1) %}
                    <!-- ARROWS -->
                    <button
                      type="button"
                      id="galleryPrev"
                      class="absolute left-4 md:left-7 top-1/2 -translate-y-1/2 z-20
                             w-11 h-11 rounded-full border border-white/10 bg-black/40 backdrop-blur
                             flex items-center justify-center text-white/80 hover:text-white hover:bg-black/60
                             transition active:scale-95"
                      aria-label="Previous image"
                    >
                      <span class="text-2xl leading-none -translate-y-[1px]">‹</span>
                    </button>

                    <button
                      type="button"
                      id="galleryNext"
                      class="absolute right-4 md:right-7 top-1/2 -translate-y-1/2 z-20
                             w-11 h-11 rounded-full border border-white/10 bg-black/40 backdrop-blur
                             flex items-center justify-center text-white/80 hover:text-white hover:bg-black/60
                             transition active:scale-95"
                      aria-label="Next image"
                    >
                      <span class="text-2xl leading-none -translate-y-[1px]">›</span>
                    </button>
                  {% endif %}
                </div>

                <!-- THUMBS -->
                <div class="flex justify-center">
                  {% if product.images and (product.images|length > 1) %}
                    <div
                      id="thumbRow"
                      class="flex gap-3 overflow-x-auto max-w-full px-1 pb-1
                             [-ms-overflow-style:none] [scrollbar-width:none] [&::-webkit-scrollbar]:hidden"
                    >
                      {% for img in product.images %}
                        <button
                          type="button"
                          class="thumb-btn shrink-0 rounded-2xl border border-white/10 bg-white/5 p-2
                                 hover:bg-white/10 transition"
                          data-src="{{ img.url }}"
                          data-index="{{ loop.index0 }}"
                          aria-label="Open image {{ loop.index }}"
                        >
                          <img
                            src="{{ img.url }}"
                            alt="{{ product.title }} thumbnail {{ loop.index }}"
                            class="h-14 w-14 md:h-16 md:w-16 object-contain rounded-xl opacity-80"
                          />
                        </button>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>

              </div>
              <!-- /GALLERY -->
            </div>
          </div>
        </div>

        <!-- RIGHT: INFO + CONFIG -->
<!-- RIGHT: INFO + CONFIG -->
<div class="lg:col-span-5 flex flex-col justify-center">
  <div class="reveal space-y-10">

    <h1 class="text-5xl md:text-6xl lg:text-7xl font-black uppercase tracking-tight leading-tight text-white">
      {{ product.title }}
    </h1>

    <div class="mt-6 space-y-4">
      <div class="flex items-baseline gap-6">
        <span id="priceValue" class="text-4xl md:text-5xl font-light text-white italic tracking-tight">
          {{ "%.2f"|format(product.base_price) }}
          <span class="text-base md:text-lg not-italic uppercase opacity-60 ml-2">€</span>
        </span>

        <span class="text-sm md:text-base uppercase tracking-wider text-zinc-400 font-light">
          Free worldwide shipping
        </span>
      </div>

      <div class="text-sm md:text-base text-zinc-400 font-light italic">
        Buy 2+ cases – 15% off automatically at checkout
      </div>

      <div class="text-sm uppercase tracking-wider text-zinc-500">
        Free remake guarantee · Secure checkout
      </div>
    </div>

    <p class="text-base md:text-lg text-zinc-300 leading-relaxed max-w-xl font-light whitespace-pre-line [font-family:'SuisseIntl',sans-serif]">
      {{ product.description or "Line one.\n\nLine two.\nLine three." }}
    </p>

    <div class="mt-10 grid grid-cols-1 md:grid-cols-2 gap-6 border-y border-white/5 py-10">
      <div class="flex items-center gap-4">
        <div class="w-2 h-2 rounded-full bg-white/40"></div>
        <span class="text-xs md:text-sm uppercase tracking-[0.15em] font-light text-zinc-300">Made to order</span>
      </div>
      <div class="flex items-center gap-4">
        <div class="w-2 h-2 rounded-full bg-white/40"></div>
        <span class="text-xs md:text-sm uppercase tracking-[0.15em] font-light text-zinc-300">Matte finish</span>
      </div>
    </div>

    <!-- CONFIGURATOR CARD -->
    <div class="mt-12 rounded-3xl border border-white/10 bg-[#0B0B0B] p-8 md:p-10 relative
            shadow-[0_0_80px_rgba(255,255,255,0.03)] overflow-visible">

      <!-- subtle top sheen -->
       <div class="absolute inset-0 rounded-3xl overflow-hidden pointer-events-none">
        <div class="absolute inset-0 bg-gradient-to-b from-white/[0.04] to-transparent"></div>
      </div>

      <div class="relative space-y-12">
        <div class="flex items-center justify-between">
          <h3 class="text-xs uppercase tracking-[0.35em] text-zinc-500">
            Configure
          </h3>
          <div class="text-[10px] uppercase tracking-wider text-zinc-600">
            Customization
          </div>
        </div>

        {% set personalization_schema = product.personalization_schema or {} %}

        <!-- PERSONALIZATION FIELDS -->
        <div class="space-y-10">
          {% for key, config in personalization_schema.items()|sort %}
            <div class="space-y-4">
              <label class="flex justify-between items-center text-sm uppercase tracking-wider text-zinc-400 font-medium">
                <span>{{ "%02d"|format(loop.index) }}. {{ key }}</span>
                <span class="text-[10px] opacity-50">{{ config.limit }} MAX</span>
              </label>

              {% if key == 'coords' %}
                <div id="coordsWidget" class="space-y-4">
                  <div class="relative group">
                    <input type="text" id="locationSearch"
                           class="w-full bg-white/[0.05] border border-white/10 rounded-2xl px-6 py-5 pr-14
                                  text-lg text-white placeholder:text-zinc-500 focus:outline-none focus:border-white/30 transition-all"
                           placeholder="{{ config.placeholder }}">
                    <button type="button" onclick="getCurrentLocation()"
                            class="absolute right-4 top-1/2 -translate-y-1/2 p-2 text-zinc-500 hover:text-white transition-colors">
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                      </svg>
                    </button>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-center bg-white/[0.03] border border-white/10 rounded-2xl overflow-hidden p-1">
                      <input type="number" id="latInput" step="0.0001" placeholder="ex. 46,8027"
                             class="flex-1 bg-transparent px-4 py-3 text-white focus:outline-none min-w-0">
                      <div class="flex flex-shrink-0 bg-black/40 rounded-xl p-1 ml-1">
                        <button type="button" onclick="toggleHem('lat', 'N')" id="btn-lat-N" class="coord-btn active">N</button>
                        <button type="button" onclick="toggleHem('lat', 'S')" id="btn-lat-S" class="coord-btn">S</button>
                      </div>
                    </div>

                    <div class="flex items-center bg-white/[0.03] border border-white/10 rounded-2xl overflow-hidden p-1">
                      <input type="number" id="lngInput" step="0.0001" placeholder="ex. 9,8360"
                             class="flex-1 bg-transparent px-4 py-3 text-white focus:outline-none min-w-0">
                      <div class="flex flex-shrink-0 bg-black/40 rounded-xl p-1 ml-1">
                        <button type="button" onclick="toggleHem('lng', 'E')" id="btn-lng-E" class="coord-btn">E</button>
                        <button type="button" onclick="toggleHem('lng', 'W')" id="btn-lng-W" class="coord-btn active">W</button>
                      </div>
                    </div>
                  </div>

                  <input type="hidden" id="finalCoords" data-personalization-key="coords">
                </div>
              {% else %}
                <div class="relative">
                  <input type="text"
                         class="w-full bg-white/[0.05] border border-white/10 rounded-2xl px-6 py-5 text-white placeholder:text-zinc-500
                                focus:outline-none focus:border-white/30 transition-all"
                         placeholder="{{ config.placeholder }}"
                         data-personalization-key="{{ key }}"
                         data-personalization-max="{{ config.limit }}"
                         maxlength="{{ config.limit }}">
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>

        <!-- DEVICE SELECTS -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 pt-2">
          <div class="space-y-4">
            <label class="block text-sm uppercase tracking-wider text-zinc-400 font-medium">Brand</label>

            <div id="brandCustomSelect" class="custom-select relative">
              <div class="select-trigger w-full bg-white/[0.05] border border-white/10 rounded-2xl px-6 py-5
                          text-lg text-white font-light cursor-pointer flex justify-between items-center
                          hover:bg-white/[0.08] transition-all">
                <span class="selected-value text-zinc-400 italic">Select…</span>
                <span class="arrow opacity-50 text-sm transition-transform duration-500">▼</span>
              </div>

              <div class="select-options absolute top-full left-0 w-full z-50 mt-3 bg-[#0F0F0F] border border-white/10
                rounded-2xl opacity-0 invisible transition-all duration-300 translate-y-2 shadow-2xl
                max-h-[60vh] overflow-y-auto overscroll-contain"></div>
            </div>
          </div>

          <div id="modelWrap" class="space-y-4 opacity-20 pointer-events-none transition-all duration-500">
            <label class="block text-sm uppercase tracking-wider text-zinc-400 font-medium">Model</label>

            <div id="modelCustomSelect" class="custom-select relative">
              <div class="select-trigger w-full bg-white/[0.05] border border-white/10 rounded-2xl px-6 py-5
                          text-lg text-white font-light cursor-pointer flex justify-between items-center
                          hover:bg-white/[0.08] transition-all">
                <span class="selected-value text-zinc-400 italic">Select…</span>
                <span class="arrow opacity-50 text-sm transition-transform duration-500">▼</span>
              </div>

              <div class="select-options absolute top-full left-0 w-full z-50 mt-3 bg-[#0F0F0F] border border-white/10
                  rounded-2xl opacity-0 invisible transition-all duration-300 translate-y-2 shadow-2xl
                  max-h-[60vh] overflow-y-auto overscroll-contain"></div>
            </div>
          </div>
        </div>

        <!-- CTA -->
        <div class="pt-2">
          <button id="addToCartBtn"
                  class="group relative w-full overflow-hidden rounded-full bg-white px-8 py-7 transition-all active:scale-95 disabled:opacity-50">
            <span class="relative z-10 text-black text-base md:text-lg font-bold uppercase tracking-wider">Add To Bag</span>
            <div class="absolute inset-0 bg-zinc-200 translate-y-full transition-transform duration-300 group-hover:translate-y-0"></div>
          </button>

          <div class="mt-6 text-center text-sm uppercase tracking-wider text-zinc-500">
            <span id="helperHint"
                  class="text-white/80 tracking-wider
                         drop-shadow-[0_0_12px_rgba(255,255,255,0.25)]">
              Select device model to generate preview
            </span>
          </div>

          <div class="mt-8 flex items-center justify-center gap-12 px-4 text-xs uppercase tracking-wider text-zinc-600 italic">
            NOIRID Certified · Secure Payment
          </div>
        </div>
      </div>
    </div>
    <!-- /CONFIGURATOR CARD -->

  </div>
</div>


      </div>
    </div>
    <div id="mobileSelectSheet"
     class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm
            opacity-0 pointer-events-none transition-all duration-300">

  <div id="sheetContent"
       class="absolute bottom-0 left-0 w-full bg-[#0F0F0F]
              rounded-t-3xl p-6 max-h-[80vh]
              translate-y-full transition-transform duration-300 overflow-y-auto">

    <div class="mb-6 text-center text-sm uppercase tracking-wider text-zinc-400">
      Select Model
    </div>

    <div id="sheetOptions" class="space-y-1"></div>
  </div>
</div>


    <!-- MOBILE STICKY BAR -->
<div id="mobileStickyBar"
     class="lg:hidden fixed bottom-0 left-0 w-full z-50
            transition-all duration-300
            border-t border-white/10 bg-[#0B0B0B]/92 backdrop-blur-xl
            px-4 pt-3 pb-[calc(0.75rem+env(safe-area-inset-bottom))]">
  <div class="mx-auto max-w-7xl flex items-center gap-3">
    <div class="min-w-[92px]">
      <div id="mobilePriceValue" class="text-white/90 text-lg font-light tracking-tight">
        {{ "%.2f"|format(product.base_price) }} €
      </div>
      <div class="text-[10px] uppercase tracking-[0.2em] text-zinc-500">
        Shipping included
      </div>
    </div>

    <button id="addToCartBtnMobile"
            class="flex-1 relative overflow-hidden rounded-full bg-white px-6 py-4
                   transition-all active:scale-95 disabled:opacity-50">
      <span class="relative z-10 text-black text-sm font-black uppercase tracking-wider">
        Add To Bag
      </span>
      <div class="absolute inset-0 bg-zinc-200 translate-y-full transition-transform duration-300
                  group-hover:translate-y-0"></div>
    </button>
  </div>
</div>


  </section>
</div>

<!-- TOAST -->
<div id="cartToast" class="fixed bottom-12 left-1/2 -translate-x-1/2 z-[60] opacity-0 pointer-events-none transition-all duration-500 translate-y-8">
  <div class="bg-white px-8 py-5 rounded-full flex items-center gap-10 shadow-[0_20px_50px_rgba(0,0,0,0.5)]">
    <div id="toastMessage" class="text-[10px] font-black uppercase tracking-[0.2em] text-black">Item Added</div>
    <a href="/cart" class="text-[10px] font-bold uppercase tracking-[0.2em] text-zinc-400 hover:text-black transition-colors">View Bag →</a>
  </div>
</div>
<script>
  (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
    key: "AIzaSyAtGqK_F3nwTfH5QoesqQnqM23Xm0tPALY",
    v: "weekly"
  });
</script>
<script>
  window.PRODUCT_DATA = {
    variants: {{ variants_payload|tojson }},
    productSlug: {{ product.slug|tojson }},
    productId: {{ product.id }}
  };
</script>
<script src="{{ url_for('static', path='js/public/product.js') }}"></script>


<style>

.pac-container {
  background-color: #0c0c0c !important; /* Глубокий черный, чуть светлее фона */
  border: 1px solid rgba(255, 255, 255, 0.1) !important;
  border-radius: 1.25rem !important; /* Округлые края в стиле твоих инпутов */
  margin-top: 8px !important;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6) !important;
  font-family: inherit !important;
  z-index: 9999 !important;
}


.pac-container:after {
  display: none !important;
}


.pac-item {
  border-top: 1px solid rgba(255, 255, 255, 0.05) !important;
  padding: 12px 20px !important;
  cursor: pointer !important;
  background: transparent !important;
  display: flex !important;
  align-items: center !important;
  color: #71717a !important; /* zinc-400 */
  transition: all 0.2s ease !important;
}

.pac-item:first-child {
  border-top: none !important;
}


.pac-item:hover {
  background-color: rgba(255, 255, 255, 0.05) !important;
  color: #ffffff !important;
}


.pac-item-query {
  color: #ffffff !important;
  font-size: 14px !important;
  font-family: inherit !important;
  padding-right: 5px !important;
}


.pac-matched {

  color: #ffffff !important;
}


.pac-icon {
  filter: invert(1) brightness(0.7) !important;
  margin-right: 10px !important;
}


.hdpi .pac-logo:after {
  filter: grayscale(1) invert(1) opacity(0.3) !important;
}
.coord-btn {
  width: 42px;
  height: 42px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 10px;
  font-size: 12px;
  font-weight: 700;
  color: #52525b; /* zinc-600 */
  transition: all 0.2s ease;
}

.coord-btn.active {
  background: rgba(255, 255, 255, 0.1);
  color: #ffffff !important;
}

/* Скрываем стрелки у числового поля */
input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
  /* Premium transitions for main image */
  .gallery-img {
    will-change: transform, opacity, filter;
    transition:
      opacity 380ms ease,
      filter 520ms ease,
      transform 900ms cubic-bezier(0.16, 1, 0.3, 1);
  }

  .gallery-leave {
    opacity: 0;
    filter: blur(7px);
    transform: scale(1.03);
  }

  .gallery-enter {
    opacity: 1;
    filter: blur(0);
    transform: scale(1);
  }

  .sheen-on { opacity: 1; }

  input::placeholder { transition: color 0.3s; }
  input:focus::placeholder { color: transparent; }

@media (min-width: 768px) {
  /* Переключаем на открытие вверх */
  .custom-select .select-options {
    top: auto !important;
    bottom: 100% !important; /* Позиционируем над кнопкой */
    margin-top: 0 !important;
    margin-bottom: 12px !important; /* Отступ от кнопки снизу */

    /* Меняем направление анимации: теперь он будет прятаться чуть ниже своего положения */
    transform: translateY(10px);
    transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1) !important;
  }

  /* Состояние, когда список открыт */
  .custom-select .select-options:not(.invisible) {
    transform: translateY(0) !important;
    opacity: 1 !important;
  }

  /* Маска затухания (теперь актуальнее, так как смотрим снизу вверх) */
  .select-options {
    max-height: 380px !important;
    overflow-y: auto;
    -webkit-mask-image: linear-gradient(to bottom,
      transparent,
      black 10%,
      black 90%,
      transparent
    );
    mask-image: linear-gradient(to bottom,
      transparent,
      black 10%,
      black 90%,
      transparent
    );
  }

  /* Тонкий скролл */
  .select-options::-webkit-scrollbar { width: 3px; }
  .select-options::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
  }
}

</style>
{% endblock %}
