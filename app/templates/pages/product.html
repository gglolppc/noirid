{% extends "base.html" %}

{% block title %}{{ product.title }} · NOIRID{% endblock %}

{% block content %}
<div class="relative bg-[#050505]">
  <section class="min-h-screen pt-36 pb-24 px-8">
    <div class="mx-auto max-w-6xl">
      <div class="reveal">
        <div class="text-[10px] uppercase tracking-[0.5em] text-zinc-600">Product</div>
        <h1 class="mt-6 text-5xl md:text-7xl font-black uppercase tracking-tight text-white">{{ product.title }}</h1>
        <p class="mt-4 text-sm md:text-base text-zinc-400 max-w-2xl">{{ product.description or "" }}</p>
      </div>

      <div class="mt-14 grid grid-cols-1 lg:grid-cols-2 gap-10">
        <div class="reveal rounded-3xl border border-white/10 bg-white/5 p-6">
          <div class="relative aspect-square rounded-2xl bg-black/40 border border-white/10 overflow-hidden">
            {% if product.images %}
              <div id="productGallery" class="flex h-full w-full overflow-x-auto snap-x snap-mandatory scroll-smooth">
                {% for image in product.images %}
                  <div class="h-full w-full flex-none snap-center">
                    <img src="{{ image.url }}" alt="{{ product.title }}" class="h-full w-full object-cover" />
                  </div>
                {% endfor %}
              </div>
              {% if product.images|length > 1 %}
                <button id="galleryPrev"
                        class="absolute left-3 top-1/2 -translate-y-1/2 rounded-full border border-white/20 bg-black/40 px-2 py-1 text-sm text-white/80 backdrop-blur hover:text-white">
                  ‹
                </button>
                <button id="galleryNext"
                        class="absolute right-3 top-1/2 -translate-y-1/2 rounded-full border border-white/20 bg-black/40 px-2 py-1 text-sm text-white/80 backdrop-blur hover:text-white">
                  ›
                </button>
              {% endif %}
            {% endif %}
          </div>
        </div>

        <div class="reveal reveal-delay-1">
          <div class="rounded-3xl border border-white/10 bg-white/5 p-8 space-y-6">
            <div class="flex items-center justify-between">
              <div class="text-sm uppercase tracking-[0.3em] text-zinc-500">Base price</div>
              <div class="text-2xl font-semibold text-white">{{ "%.2f"|format(product.base_price) }} {{ product.currency }}</div>
            </div>

            <div>
              <label class="text-sm text-zinc-400">Personalization</label>
              <input id="personalizationInput" type="text" required
                     class="mt-2 w-full rounded-2xl bg-zinc-950 border border-white/10 px-4 py-3 text-sm"
                     placeholder="Enter your text">
            </div>

            <div>
              <label class="text-sm text-zinc-400">Select brand</label>
              <select id="brandSelect" class="mt-2 w-full rounded-2xl bg-zinc-950 border border-white/10 px-4 py-3 text-sm">
                <option value="">Select brand</option>
              </select>
            </div>

            <div id="modelWrap" class="hidden">
              <label class="text-sm text-zinc-400">Select model</label>
              <select id="modelSelect" class="mt-2 w-full rounded-2xl bg-zinc-950 border border-white/10 px-4 py-3 text-sm">
                <option value="">Select model</option>
              </select>
            </div>

            <div class="flex flex-wrap gap-3">
              <button id="addToCartBtn"
                      class="rounded-2xl bg-white text-zinc-950 px-6 py-3 text-[11px] uppercase tracking-[0.4em] font-semibold">
                Add to cart
              </button>
              <a href="/catalog" class="rounded-2xl border border-white/15 px-6 py-3 text-[11px] uppercase tracking-[0.4em] font-semibold text-zinc-200 hover:bg-white/5">
                Back
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<div id="cartToast" class="pointer-events-none fixed inset-0 flex items-center justify-center opacity-0 transition-opacity duration-300">
  <div class="pointer-events-auto rounded-2xl bg-zinc-900/90 border border-white/10 px-6 py-4 flex items-center gap-4 shadow-xl">
    <div class="text-sm">Added to cart</div>
    <a href="/cart" class="rounded-xl bg-white text-zinc-950 px-4 py-2 text-xs font-semibold">
      Open cart
    </a>
  </div>
</div>

<script>
  const variants = {{ variants_payload|tojson }};
  const brandSelect = document.getElementById('brandSelect');
  const modelSelect = document.getElementById('modelSelect');
  const modelWrap = document.getElementById('modelWrap');
  const gallery = document.getElementById('productGallery');
  const galleryPrev = document.getElementById('galleryPrev');
  const galleryNext = document.getElementById('galleryNext');

  function scrollGallery(direction) {
    if (!gallery) return;
    const amount = gallery.clientWidth;
    gallery.scrollBy({ left: amount * direction, behavior: 'smooth' });
  }

  galleryPrev?.addEventListener('click', () => scrollGallery(-1));
  galleryNext?.addEventListener('click', () => scrollGallery(1));

  const brands = [...new Set(variants.map(v => v.brand))].sort();
  brands.forEach((brand) => {
    const opt = document.createElement('option');
    opt.value = brand;
    opt.textContent = brand;
    brandSelect.appendChild(opt);
  });

  brandSelect.addEventListener('change', () => {
    const brand = brandSelect.value;
    modelSelect.innerHTML = '<option value="">Select model</option>';
    if (!brand) {
      modelWrap.classList.add('hidden');
      return;
    }
    const models = variants.filter(v => v.brand === brand).map(v => v.model);
    [...new Set(models)].sort().forEach((model) => {
      const opt = document.createElement('option');
      opt.value = model;
      opt.textContent = model;
      modelSelect.appendChild(opt);
    });
    modelWrap.classList.remove('hidden');
  });

  function showToast() {
    const toast = document.getElementById('cartToast');
    toast.classList.remove('opacity-0');
    toast.classList.add('opacity-100');
    setTimeout(() => {
      toast.classList.add('opacity-0');
      toast.classList.remove('opacity-100');
    }, 2000);
  }

  document.getElementById('addToCartBtn').addEventListener('click', async () => {
    const brand = brandSelect.value;
    const model = modelSelect.value;
    const personalization = document.getElementById('personalizationInput').value.trim();

    if (!personalization) {
      alert('Please enter personalization text.');
      return;
    }
    if (!brand || !model) {
      alert('Please select a brand and model.');
      return;
    }

    const match = variants.find(v => v.brand === brand && v.model === model);
    const variantId = match ? match.id : null;

    const res = await fetch('/api/cart/add', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        product_id: {{ product.id }},
        variant_id: variantId,
        qty: 1,
        personalization: { text: personalization }
      })
    });

    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      alert(data.detail || 'Failed to add');
      return;
    }

    showToast();
  });
</script>
{% endblock %}
