{% extends "base.html" %}

{% block title %}{{ product.title }} · NOIRID{% endblock %}

{% block content %}
<div class="relative bg-[#050505] selection:bg-white selection:text-black min-h-screen text-zinc-300">
  <nav class="absolute top-8 left-6 md:left-12 z-40">
    <a href="/catalog" class="group flex items-center gap-3 text-sm md:text-base uppercase tracking-wider text-zinc-400 hover:text-white transition-colors">
      <span class="transition-transform group-hover:-translate-x-1">←</span> Back to Catalog
    </a>
  </nav>

  <section class="pt-24 md:pt-32 pb-32 px-6 md:px-12">
    <div class="mx-auto max-w-7xl">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-12 lg:gap-20">

        <!-- LEFT: PREVIEW (sticky) -->
        <div class="lg:col-span-7">
          <div class="lg:sticky lg:top-32">
            <div class="relative aspect-[4/5] rounded-3xl md:rounded-4xl border border-white/5 bg-[#080808] overflow-hidden group shadow-2xl">
              <div class="pointer-events-none absolute inset-0 z-10 shadow-[inset_0_0_160px_rgba(0,0,0,0.7)]"></div>

              <div id="previewBadge"
                   class="hidden absolute top-8 left-8 z-20 rounded-full bg-white/5 backdrop-blur-lg px-6 py-3
                          text-sm uppercase tracking-wider text-white/80 border border-white/10">
                Live Preview
              </div>

              <div id="previewSpinner" class="hidden flex absolute inset-0 z-30 items-center justify-center bg-black/30 backdrop-blur-sm">
                <div class="flex flex-col items-center gap-6">
                  <div class="w-16 h-0.5 bg-white/20 overflow-hidden relative">
                    <div class="absolute inset-0 bg-white translate-x-[-100%] animate-[shimmer_1.5s_infinite]"></div>
                  </div>
                  <span class="text-sm uppercase tracking-wider text-white font-light">
                    Refining Your Design
                  </span>
                </div>
              </div>

              <div id="productGallery" class="flex h-full w-full items-center justify-center p-12 md:p-20">
                {% if product.images %}
                  <img id="mainProductImg"
                       src="{{ product.images[0].url }}"
                       alt="{{ product.title }}"
                       class="gallery-img h-full w-full object-contain transition-transform duration-1000 group-hover:scale-105" />
                {% else %}
                  <img id="mainProductImg"
                       src="/static/img/placeholder.webp"
                       alt="{{ product.title }}"
                       class="gallery-img h-full w-full object-contain transition-transform duration-1000 group-hover:scale-105" />
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT: INFO + CONFIG -->
        <div class="lg:col-span-5 flex flex-col justify-center">
          <div class="reveal space-y-10">



            <h1 class="text-5xl md:text-6xl lg:text-7xl font-black uppercase tracking-tight leading-tight text-white">
              {{ product.title }}
            </h1>

            <!-- PRICE + DISCOUNT (если добавишь) -->
            <div class="mt-6 space-y-4">
              <div class="flex items-baseline gap-6">
                <span id="priceValue" class="text-4xl md:text-5xl font-light text-white italic tracking-tight">
                  {{ "%.2f"|format(product.base_price) }}
                  <span class="text-base md:text-lg not-italic uppercase opacity-60 ml-2">{{ product.currency }}</span>
                </span>

                <span class="text-sm md:text-base uppercase tracking-wider text-zinc-400 font-light">
                  Free worldwide shipping
                </span>
              </div>

              <!-- Добавь скидку здесь, как я советовал ранее -->
              <div class="text-sm md:text-base text-zinc-400 font-light italic">
                Buy 2+ cases – 15% off automatically at checkout
              </div>

              <div class="text-sm uppercase tracking-wider text-zinc-500">
                Free remake guarantee · Secure checkout
              </div>
            </div>

            <p class="text-base md:text-lg text-zinc-300 leading-relaxed max-w-xl font-light">
              {{ product.description or "Premium protection with discreet personalization — visible only in the light. Raised texture, matte finish, and perfect fit for your device." }}
            </p>

            <!-- FEATURES (упростил, сделал крупнее) -->
            <div class="mt-10 grid grid-cols-1 md:grid-cols-2 gap-6 border-y border-white/5 py-10">
              <div class="flex items-center gap-4">
                <div class="w-2 h-2 rounded-full bg-white/40"></div>
                <span class="text-base md:text-lg uppercase tracking-wide text-zinc-400">Precision Fit</span>
              </div>
              <div class="flex items-center gap-4">
                <div class="w-2 h-2 rounded-full bg-white/40"></div>
                <span class="text-base md:text-lg uppercase tracking-wide text-zinc-400">Matte Texture</span>
              </div>
            </div>

            <!-- PERSONALIZATION + SELECTS -->
            <div class="mt-12 space-y-12">
              {% set personalization_schema = product.personalization_schema or {} %}

              {% for key, limit in personalization_schema.items()|sort %}
                {% set limit_value = limit.max_len if limit is mapping and limit.max_len is defined else limit %}
                <div class="space-y-4">
                  <label class="block text-sm uppercase tracking-wider text-zinc-400 font-medium">
                    {{ "%02d"|format(loop.index) }}. {{ key }}
                  </label>

                  <div class="relative">
                    <input type="text"
                           class="w-full bg-white/[0.05] border border-white/10 rounded-2xl px-6 py-5
                                  text-lg md:text-xl text-white placeholder:text-zinc-500
                                  focus:outline-none focus:border-white/30 focus:bg-white/[0.08]
                                  transition-all duration-300 font-light tracking-wide"
                           placeholder="Type here…"
                           data-personalization-key="{{ key }}"
                           data-personalization-max="{{ limit_value }}"
                           maxlength="{{ limit_value }}">
                    <span class="absolute right-6 top-1/2 -translate-y-1/2 text-sm text-zinc-500 font-mono">
                      MAX {{ limit_value }}
                    </span>
                  </div>
                </div>
              {% endfor %}

              <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-4">
                  <label class="block text-sm uppercase tracking-wider text-zinc-400 font-medium">Brand</label>

                  <div id="brandCustomSelect" class="custom-select relative">
                    <div class="select-trigger w-full bg-white/[0.05] border border-white/10 rounded-2xl px-6 py-5
                                text-lg text-white font-light cursor-pointer flex justify-between items-center
                                hover:bg-white/[0.08] transition-all">
                      <span class="selected-value text-zinc-400 italic">Select…</span>
                      <span class="arrow opacity-50 text-sm transition-transform duration-500">▼</span>
                    </div>

                    <div class="select-options absolute top-full left-0 w-full z-50 mt-3 bg-[#0F0F0F] border border-white/10
                                rounded-2xl overflow-hidden opacity-0 invisible transition-all duration-300 translate-y-2 shadow-2xl"></div>
                  </div>
                </div>

                <div id="modelWrap" class="space-y-4 opacity-20 pointer-events-none transition-all duration-500">
                  <label class="block text-sm uppercase tracking-wider text-zinc-400 font-medium">Model</label>

                  <div id="modelCustomSelect" class="custom-select relative">
                    <div class="select-trigger w-full bg-white/[0.05] border border-white/10 rounded-2xl px-6 py-5
                                text-lg text-white font-light cursor-pointer flex justify-between items-center
                                hover:bg-white/[0.08] transition-all">
                      <span class="selected-value text-zinc-400 italic">Select…</span>
                      <span class="arrow opacity-50 text-sm transition-transform duration-500">▼</span>
                    </div>

                    <div class="select-options absolute top-full left-0 w-full z-50 mt-3 bg-[#0F0F0F] border border-white/10
                                rounded-2xl overflow-hidden opacity-0 invisible transition-all duration-300 translate-y-2 shadow-2xl"></div>
                  </div>
                </div>
              </div>

              <!-- CTA -->
              <div class="pt-8">
                <button id="addToCartBtn"
                        class="group relative w-full overflow-hidden rounded-full bg-white px-8 py-7 transition-all active:scale-95 disabled:opacity-50">
                  <span class="relative z-10 text-black text-base md:text-lg font-bold uppercase tracking-wider">Add To Bag</span>
                  <div class="absolute inset-0 bg-zinc-200 translate-y-full transition-transform duration-300 group-hover:translate-y-0"></div>
                </button>

                <div class="mt-6 text-center text-sm uppercase tracking-wider text-zinc-500">
                  <span id="helperHint">Select device model to generate preview</span>
                </div>

                <div class="mt-8 flex items-center justify-center gap-12 px-4 text-xs uppercase tracking-wider text-zinc-600 italic">
                  NOIRID Certified · Secure Payment
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>
</div>

<!-- TOAST (оставил без изменений) -->
<div id="cartToast" class="fixed bottom-12 left-1/2 -translate-x-1/2 z-[60] opacity-0 pointer-events-none transition-all duration-500 translate-y-8">
  <div class="bg-white px-8 py-5 rounded-full flex items-center gap-10 shadow-[0_20px_50px_rgba(0,0,0,0.5)]">
    <div id="toastMessage" class="text-sm font-black uppercase tracking-wider text-black">Item Added</div>
    <a href="/cart" class="text-sm font-bold uppercase tracking-wider text-zinc-400 hover:text-black transition-colors">View Bag →</a>
  </div>
</div>

<!-- TOAST -->
<div id="cartToast" class="fixed bottom-12 left-1/2 -translate-x-1/2 z-[60] opacity-0 pointer-events-none transition-all duration-500 translate-y-8">
  <div class="bg-white px-8 py-5 rounded-full flex items-center gap-10 shadow-[0_20px_50px_rgba(0,0,0,0.5)]">
    <div id="toastMessage" class="text-[10px] font-black uppercase tracking-[0.2em] text-black">Item Added</div>
    <a href="/cart" class="text-[10px] font-bold uppercase tracking-[0.2em] text-zinc-400 hover:text-black transition-colors">View Bag →</a>
  </div>
</div>

<script>
  const variants = {{ variants_payload|tojson }};
  const productSlug = {{ product.slug|tojson }};

  let selectedBrand = null, selectedModel = null, selectedVariant = null;
  let previewAbort = null, previewTimer = null, previewPublicUrl = null;

  const previewSpinner = document.getElementById('previewSpinner');
  const previewBadge = document.getElementById('previewBadge');
  const helperHint = document.getElementById('helperHint');
  const mainImg = document.getElementById('mainProductImg');
  const priceValue = document.getElementById('priceValue');

  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  function closeAllSelects() {
    document.querySelectorAll('.select-options').forEach(el => {
      el.classList.add('opacity-0', 'invisible', 'translate-y-2');
      const arrow = el.parentElement.querySelector('.arrow');
      if (arrow) arrow.style.transform = 'rotate(0deg)';
    });
  }
  document.addEventListener('click', closeAllSelects);

  function initCustomSelect(containerId, options, onSelect) {
    const container = document.getElementById(containerId);
    const trigger = container.querySelector('.select-trigger');
    const optionsList = container.querySelector('.select-options');
    const label = trigger.querySelector('.selected-value');
    const arrow = trigger.querySelector('.arrow');

    trigger.onclick = (e) => {
      e.stopPropagation();
      const isVisible = !optionsList.classList.contains('opacity-0');
      closeAllSelects();
      if (!isVisible) {
        optionsList.classList.remove('opacity-0', 'invisible', 'translate-y-2');
        arrow.style.transform = 'rotate(180deg)';
      }
    };

    optionsList.innerHTML = options.map(opt => `
      <div class="px-6 py-4 text-zinc-300 hover:bg-white/5 hover:text-white cursor-pointer text-[12px] uppercase tracking-widest transition-all" data-value="${opt}">
        ${opt}
      </div>
    `).join('');

    optionsList.querySelectorAll('[data-value]').forEach(item => {
      item.onclick = (e) => {
        e.stopPropagation();
        const val = item.getAttribute('data-value');

        label.textContent = val;
        label.classList.remove('text-zinc-400', 'italic');
        label.classList.add('text-white');

        closeAllSelects();
        onSelect(val);
      };
    });
  }

  function collectPersonalization({ requireAll }) {
    const inputs = document.querySelectorAll('[data-personalization-key]');
    const out = {};
    let anyFilled = false;

    for (const i of inputs) {
      const key = i.getAttribute('data-personalization-key');
      const val = (i.value || '').trim();
      if (val) anyFilled = true;
      if (requireAll && !val) return { ok: false, personalization: null };
      if (val) out[key] = val;
    }
    if (!anyFilled) return { ok: false, personalization: null };
    return { ok: true, personalization: out };
  }

  function updatePriceUI() {
    if (!selectedVariant) return;
    if (typeof selectedVariant.price === 'number' || typeof selectedVariant.price === 'string') {
      const p = Number(selectedVariant.price);
      if (!Number.isNaN(p)) {
        priceValue.innerHTML = `${p.toFixed(2)} <span class="text-xs md:text-sm not-italic uppercase opacity-40">{{ product.currency }}</span>`;
      }
    }
  }

  function setHint(text) {
    if (helperHint) helperHint.textContent = text;
  }

  function setPreviewLoading(isLoading) {
    if (isLoading) {
      previewSpinner.classList.remove('hidden');
      previewBadge.classList.add('hidden');
    } else {
      previewSpinner.classList.add('hidden');
    }
  }

  async function fetchPreviewNow({ force = false } = {}) {
    if (!selectedVariant) return;

    const p = collectPersonalization({ requireAll: false });
    if (!p.ok) {
      if (force) notify('Fill at least one field', true);
      return;
    }

    try { previewAbort?.abort(); } catch (e) {}
    previewAbort = new AbortController();

    setPreviewLoading(true);
    previewPublicUrl = null;

    try {
      const res = await fetch('/api/mockups/preview', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        signal: previewAbort.signal,
        body: JSON.stringify({
          product_slug: productSlug,
          variant_id: selectedVariant.id,
          personalization: p.personalization
        })
      });

      previewPublicUrl = res.headers.get("X-Preview-Url");

      const blob = await res.blob();
      const url = URL.createObjectURL(blob);

      mainImg.style.opacity = '0';
      await sleep(220);

      mainImg.src = url;
      mainImg.style.opacity = '1';

      setPreviewLoading(false);
      previewBadge.classList.remove('hidden');
      setHint('Preview generated · ready to add to bag');

    } catch (e) {
      if (e.name !== 'AbortError') {
        setPreviewLoading(false);
        if (force) notify('Preview error', true);
      }
    }
  }

  const brands = [...new Set(variants.map(v => v.brand))].sort();
  initCustomSelect('brandCustomSelect', brands, (brand) => {
    selectedBrand = brand;
    selectedModel = null;
    selectedVariant = null;
    previewPublicUrl = null;

    setHint('Select your model to generate preview');

    const wrap = document.getElementById('modelWrap');
    wrap.classList.remove('opacity-20', 'pointer-events-none');

    const models = variants.filter(v => v.brand === brand).map(v => v.model);
    initCustomSelect('modelCustomSelect', [...new Set(models)].sort(), (model) => {
      selectedModel = model;
      selectedVariant = variants.find(v => v.brand === selectedBrand && v.model === selectedModel);

      updatePriceUI();
      setHint('Type personalization to generate preview');
      fetchPreviewNow();
    });
  });

  document.querySelectorAll('[data-personalization-key]').forEach(inp => {
    inp.addEventListener('input', () => {
      clearTimeout(previewTimer);
      previewTimer = setTimeout(() => {
        if (!selectedVariant) return;
        setHint('Generating preview…');
        fetchPreviewNow();
      }, 700);
    });
  });

  function notify(msg, isError = false) {
    const toast = document.getElementById('cartToast');
    const m = document.getElementById('toastMessage');
    m.textContent = msg;
    m.className = isError
      ? 'text-[10px] font-black uppercase tracking-[0.2em] text-red-500'
      : 'text-[10px] font-black uppercase tracking-[0.2em] text-black';

    toast.classList.remove('opacity-0', 'translate-y-8', 'pointer-events-none');
    setTimeout(() => toast.classList.add('opacity-0', 'translate-y-8', 'pointer-events-none'), 3000);
  }

  document.getElementById('addToCartBtn').onclick = async () => {
    if (!selectedVariant) {
      setHint('Select device model to continue');
      return notify('Select Device', true);
    }

    const p = collectPersonalization({ requireAll: true });
    if (!p.ok) {
      setHint('Fill all personalization fields');
      return notify('Check Fields', true);
    }

    const btn = document.getElementById('addToCartBtn');
    btn.disabled = true;
    const original = btn.innerHTML;
    btn.innerHTML = '<span class="text-black text-[11px] font-bold uppercase tracking-[0.5em] animate-pulse">Wait...</span>';

    try {
      if (!previewPublicUrl) {
        setHint('Generating preview…');
        await fetchPreviewNow({ force: true });
      }

      let attempts = 0;
      while (!previewPublicUrl && attempts < 15) {
        await sleep(120);
        attempts++;
      }

      const res = await fetch('/api/cart/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          product_id: {{ product.id }},
          variant_id: selectedVariant.id,
          qty: 1,
          personalization: p.personalization,
          preview_url: previewPublicUrl
        })
      });

      if (res.ok) {
        const cart = await res.json().catch(() => null)
        window.dispatchEvent(new CustomEvent("cart:updated", { detail: cart }))
        setHint('Added to bag · you can checkout anytime');
        notify('Added to bag');
      } else {
        setHint('Could not add to bag');
        notify('Error', true);
      }

    } catch (e) {
      setHint('Could not add to bag');
      notify('Error', true);
    } finally {
      btn.disabled = false;
      btn.innerHTML = original;
    }
  };

  setHint('Select device model to generate preview');
</script>

<style>
  @keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }
  .gallery-img { transition: opacity 0.4s ease, transform 0.8s cubic-bezier(0.16, 1, 0.3, 1); }
  input::placeholder { transition: color 0.3s; }
  input:focus::placeholder { color: transparent; }
</style>
{% endblock %}
