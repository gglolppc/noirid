{% extends "base.html" %}

{% block title %}{{ product.title }} · NOIRID{% endblock %}

{% block content %}
<div class="relative bg-[#050505] selection:bg-white selection:text-black min-h-screen text-zinc-300">
  <nav class="absolute top-8 left-6 md:left-12 z-40">
    <a href="/catalog" class="group flex items-center gap-3 text-sm md:text-base uppercase tracking-wider text-zinc-400 hover:text-white transition-colors">
      <span class="transition-transform group-hover:-translate-x-1">←</span> Back to Catalog
    </a>
  </nav>

  <section class="pt-24 md:pt-32 pb-32 px-6 md:px-12">
    <div class="mx-auto max-w-7xl">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-12 lg:gap-20">

        <!-- LEFT: PREVIEW (sticky) -->
        <div id="product-preview" class="lg:col-span-7">
          <div class="lg:sticky lg:top-32">
            <div class="relative aspect-[4/5] rounded-3xl md:rounded-4xl border border-white/5 bg-[#080808] overflow-hidden group shadow-2xl">
              <div class="pointer-events-none absolute inset-0 z-10 shadow-[inset_0_0_160px_rgba(0,0,0,0.7)]"></div>

              <div id="previewBadge"
                   class="hidden absolute top-8 left-8 z-20 rounded-full bg-white/5 backdrop-blur-lg px-6 py-3
                          text-sm uppercase tracking-wider text-white/80 border border-white/10">
                Live Preview
              </div>

              <div id="previewSpinner" class="hidden flex absolute inset-0 z-30 items-center justify-center bg-black/30 backdrop-blur-sm">
                <div class="flex flex-col items-center gap-6">
                  <div class="w-16 h-0.5 bg-white/20 overflow-hidden relative">
                    <div class="absolute inset-0 bg-white translate-x-[-100%] animate-[shimmer_1.5s_infinite]"></div>
                  </div>
                  <span class="text-sm uppercase tracking-wider text-white font-light">
                    Refining Your Design
                  </span>
                </div>
              </div>

              <!-- GALLERY -->
              <div id="productGallery" class="flex flex-col h-full w-full p-10 md:p-14 gap-6">

                <!-- MAIN -->
                <div class="relative flex-1 flex items-center justify-center">
                  {% if product.images %}
                    <img
                      id="mainProductImg"
                      src="{{ product.images[0].url }}"
                      alt="{{ product.title }}"
                      class="gallery-img h-full w-full object-contain group-hover:scale-105"
                    />
                  {% else %}
                    <img
                      id="mainProductImg"
                      src="/static/img/placeholder.webp"
                      alt="{{ product.title }}"
                      class="gallery-img h-full w-full object-contain group-hover:scale-105"
                    />
                  {% endif %}

                  <!-- premium sheen overlay -->
                  <div id="gallerySheen" class="pointer-events-none absolute inset-0 opacity-0 transition-opacity duration-700
                       bg-[radial-gradient(circle_at_30%_20%,rgba(255,255,255,0.08),transparent_45%)]"></div>

                  {% if product.images and (product.images|length > 1) %}
                    <!-- ARROWS -->
                    <button
                      type="button"
                      id="galleryPrev"
                      class="absolute left-4 md:left-7 top-1/2 -translate-y-1/2 z-20
                             w-11 h-11 rounded-full border border-white/10 bg-black/40 backdrop-blur
                             flex items-center justify-center text-white/80 hover:text-white hover:bg-black/60
                             transition active:scale-95"
                      aria-label="Previous image"
                    >
                      <span class="text-2xl leading-none -translate-y-[1px]">‹</span>
                    </button>

                    <button
                      type="button"
                      id="galleryNext"
                      class="absolute right-4 md:right-7 top-1/2 -translate-y-1/2 z-20
                             w-11 h-11 rounded-full border border-white/10 bg-black/40 backdrop-blur
                             flex items-center justify-center text-white/80 hover:text-white hover:bg-black/60
                             transition active:scale-95"
                      aria-label="Next image"
                    >
                      <span class="text-2xl leading-none -translate-y-[1px]">›</span>
                    </button>
                  {% endif %}
                </div>

                <!-- THUMBS -->
                <div class="flex justify-center">
                  {% if product.images and (product.images|length > 1) %}
                    <div
                      id="thumbRow"
                      class="flex gap-3 overflow-x-auto max-w-full px-1 pb-1
                             [-ms-overflow-style:none] [scrollbar-width:none] [&::-webkit-scrollbar]:hidden"
                    >
                      {% for img in product.images %}
                        <button
                          type="button"
                          class="thumb-btn shrink-0 rounded-2xl border border-white/10 bg-white/5 p-2
                                 hover:bg-white/10 transition"
                          data-src="{{ img.url }}"
                          data-index="{{ loop.index0 }}"
                          aria-label="Open image {{ loop.index }}"
                        >
                          <img
                            src="{{ img.url }}"
                            alt="{{ product.title }} thumbnail {{ loop.index }}"
                            class="h-14 w-14 md:h-16 md:w-16 object-contain rounded-xl opacity-80"
                          />
                        </button>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>

              </div>
              <!-- /GALLERY -->
            </div>
          </div>
        </div>

        <!-- RIGHT: INFO + CONFIG -->
        <div class="lg:col-span-5 flex flex-col justify-center">
          <div class="reveal space-y-10">

            <h1 class="text-5xl md:text-6xl lg:text-7xl font-black uppercase tracking-tight leading-tight text-white">
              {{ product.title }}
            </h1>

            <div class="mt-6 space-y-4">
              <div class="flex items-baseline gap-6">
                <span id="priceValue" class="text-4xl md:text-5xl font-light text-white italic tracking-tight">
                  {{ "%.2f"|format(product.base_price) }}
                  <span class="text-base md:text-lg not-italic uppercase opacity-60 ml-2">€</span>
                </span>

                <span class="text-sm md:text-base uppercase tracking-wider text-zinc-400 font-light">
                  Free worldwide shipping
                </span>
              </div>

              <div class="text-sm md:text-base text-zinc-400 font-light italic">
                Buy 2+ cases – 15% off automatically at checkout
              </div>

              <div class="text-sm uppercase tracking-wider text-zinc-500">
                Free remake guarantee · Secure checkout
              </div>
            </div>

            <p class="text-base md:text-lg text-zinc-300 leading-relaxed max-w-xl font-light">
              {{ product.description or "Premium protection with discreet personalization — visible only in the light. Raised texture, matte finish, and perfect fit for your device." }}
            </p>

            <div class="mt-10 grid grid-cols-1 md:grid-cols-2 gap-6 border-y border-white/5 py-10">
              <div class="flex items-center gap-4">
                <div class="w-2 h-2 rounded-full bg-white/40"></div>
                <span class="text-base md:text-lg uppercase tracking-wide text-zinc-400">Precision Fit</span>
              </div>
              <div class="flex items-center gap-4">
                <div class="w-2 h-2 rounded-full bg-white/40"></div>
                <span class="text-base md:text-lg uppercase tracking-wide text-zinc-400">Matte Texture</span>
              </div>
            </div>

            <div class="mt-12 space-y-12">
              {% set personalization_schema = product.personalization_schema or {} %}

              {% for key, config in personalization_schema.items()|sort %}
  <div class="space-y-4">
    <label class="flex justify-between items-center text-sm uppercase tracking-wider text-zinc-400 font-medium">
      <span>{{ "%02d"|format(loop.index) }}. {{ key }}</span>
      <span class="text-[10px] opacity-50">{{ config.limit }} MAX</span>
    </label>

    {% if key == 'coords' %}
 <div id="coordsWidget" class="space-y-4">
  <div class="relative group">
    <input type="text" id="locationSearch"
           class="w-full bg-white/[0.05] border border-white/10 rounded-2xl px-6 py-5 pr-14
                  text-lg text-white placeholder:text-zinc-500 focus:outline-none focus:border-white/30 transition-all"
           placeholder="{{ config.placeholder }}">
    <button type="button" onclick="getCurrentLocation()"
            class="absolute right-4 top-1/2 -translate-y-1/2 p-2 text-zinc-500 hover:text-white transition-colors">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
    </button>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div class="flex items-center bg-white/[0.03] border border-white/10 rounded-2xl overflow-hidden p-1">
      <input type="number" id="latInput" step="0.0001" placeholder="ex. 46,8027"
             class="flex-1 bg-transparent px-4 py-3 text-white focus:outline-none min-w-0">
      <div class="flex flex-shrink-0 bg-black/40 rounded-xl p-1 ml-1">
        <button type="button" onclick="toggleHem('lat', 'N')" id="btn-lat-N" class="coord-btn active">N</button>
        <button type="button" onclick="toggleHem('lat', 'S')" id="btn-lat-S" class="coord-btn">S</button>
      </div>
    </div>

    <div class="flex items-center bg-white/[0.03] border border-white/10 rounded-2xl overflow-hidden p-1">
      <input type="number" id="lngInput" step="0.0001" placeholder="ex. 9,8360"
             class="flex-1 bg-transparent px-4 py-3 text-white focus:outline-none min-w-0">
      <div class="flex flex-shrink-0 bg-black/40 rounded-xl p-1 ml-1">
        <button type="button" onclick="toggleHem('lng', 'E')" id="btn-lng-E" class="coord-btn">E</button>
        <button type="button" onclick="toggleHem('lng', 'W')" id="btn-lng-W" class="coord-btn active">W</button>
      </div>
    </div>
  </div>
  <input type="hidden" id="finalCoords" data-personalization-key="coords">
</div>

    {% else %}
      <div class="relative">
        <input type="text"
               class="w-full bg-white/[0.05] border border-white/10 rounded-2xl px-6 py-5"
               placeholder="{{ config.placeholder }}"
               data-personalization-key="{{ key }}"
               data-personalization-max="{{ config.limit }}"
               maxlength="{{ config.limit }}">
      </div>
    {% endif %}
  </div>
{% endfor %}

              <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-4">
                  <label class="block text-sm uppercase tracking-wider text-zinc-400 font-medium">Brand</label>

                  <div id="brandCustomSelect" class="custom-select relative">
                    <div class="select-trigger w-full bg-white/[0.05] border border-white/10 rounded-2xl px-6 py-5
                                text-lg text-white font-light cursor-pointer flex justify-between items-center
                                hover:bg-white/[0.08] transition-all">
                      <span class="selected-value text-zinc-400 italic">Select…</span>
                      <span class="arrow opacity-50 text-sm transition-transform duration-500">▼</span>
                    </div>

                    <div class="select-options absolute top-full left-0 w-full z-50 mt-3 bg-[#0F0F0F] border border-white/10
                                rounded-2xl overflow-hidden opacity-0 invisible transition-all duration-300 translate-y-2 shadow-2xl"></div>
                  </div>
                </div>

                <div id="modelWrap" class="space-y-4 opacity-20 pointer-events-none transition-all duration-500">
                  <label class="block text-sm uppercase tracking-wider text-zinc-400 font-medium">Model</label>

                  <div id="modelCustomSelect" class="custom-select relative">
                    <div class="select-trigger w-full bg-white/[0.05] border border-white/10 rounded-2xl px-6 py-5
                                text-lg text-white font-light cursor-pointer flex justify-between items-center
                                hover:bg-white/[0.08] transition-all">
                      <span class="selected-value text-zinc-400 italic">Select…</span>
                      <span class="arrow opacity-50 text-sm transition-transform duration-500">▼</span>
                    </div>

                    <div class="select-options absolute top-full left-0 w-full z-50 mt-3 bg-[#0F0F0F] border border-white/10
                                rounded-2xl overflow-hidden opacity-0 invisible transition-all duration-300 translate-y-2 shadow-2xl"></div>
                  </div>
                </div>
              </div>

              <div class="pt-8">
                <button id="addToCartBtn"
                        class="group relative w-full overflow-hidden rounded-full bg-white px-8 py-7 transition-all active:scale-95 disabled:opacity-50">
                  <span class="relative z-10 text-black text-base md:text-lg font-bold uppercase tracking-wider">Add To Bag</span>
                  <div class="absolute inset-0 bg-zinc-200 translate-y-full transition-transform duration-300 group-hover:translate-y-0"></div>
                </button>

                <div class="mt-6 text-center text-sm uppercase tracking-wider text-zinc-500">
                  <span id="helperHint">Select device model to generate preview</span>
                </div>

                <div class="mt-8 flex items-center justify-center gap-12 px-4 text-xs uppercase tracking-wider text-zinc-600 italic">
                  NOIRID Certified · Secure Payment
                </div>
              </div>
            </div>

          </div>
        </div>

      </div>
    </div>
  </section>
</div>

<!-- TOAST -->
<div id="cartToast" class="fixed bottom-12 left-1/2 -translate-x-1/2 z-[60] opacity-0 pointer-events-none transition-all duration-500 translate-y-8">
  <div class="bg-white px-8 py-5 rounded-full flex items-center gap-10 shadow-[0_20px_50px_rgba(0,0,0,0.5)]">
    <div id="toastMessage" class="text-[10px] font-black uppercase tracking-[0.2em] text-black">Item Added</div>
    <a href="/cart" class="text-[10px] font-bold uppercase tracking-[0.2em] text-zinc-400 hover:text-black transition-colors">View Bag →</a>
  </div>
</div>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAtGqK_F3nwTfH5QoesqQnqM23Xm0tPALY&libraries=places"></script>
<script>
  const variants = {{ variants_payload|tojson }};
  const productSlug = {{ product.slug|tojson }};

  let selectedBrand = null, selectedModel = null, selectedVariant = null;
  let previewAbort = null, previewTimer = null, previewPublicUrl = null;

  const previewSpinner = document.getElementById('previewSpinner');
  const previewBadge = document.getElementById('previewBadge');
  const helperHint = document.getElementById('helperHint');
  const mainImg = document.getElementById('mainProductImg');
  const priceValue = document.getElementById('priceValue');

  const sheen = document.getElementById('gallerySheen');
  const thumbs = Array.from(document.querySelectorAll('.thumb-btn'));
  const prevBtn = document.getElementById('galleryPrev');
  const nextBtn = document.getElementById('galleryNext');

  let galleryIndex = 0;
  let galleryLocked = false;

  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  function closeAllSelects() {
    document.querySelectorAll('.select-options').forEach(el => {
      el.classList.add('opacity-0', 'invisible', 'translate-y-2');
      const arrow = el.parentElement.querySelector('.arrow');
      if (arrow) arrow.style.transform = 'rotate(0deg)';
    });
  }
  document.addEventListener('click', closeAllSelects);

  function initCustomSelect(containerId, options, onSelect) {
    const container = document.getElementById(containerId);
    const trigger = container.querySelector('.select-trigger');
    const optionsList = container.querySelector('.select-options');
    const label = trigger.querySelector('.selected-value');
    const arrow = trigger.querySelector('.arrow');

    trigger.onclick = (e) => {
      e.stopPropagation();
      const isVisible = !optionsList.classList.contains('opacity-0');
      closeAllSelects();
      if (!isVisible) {
        optionsList.classList.remove('opacity-0', 'invisible', 'translate-y-2');
        arrow.style.transform = 'rotate(180deg)';
      }
    };

    optionsList.innerHTML = options.map(opt => `
      <div class="px-6 py-4 text-zinc-300 hover:bg-white/5 hover:text-white cursor-pointer text-[12px] uppercase tracking-widest transition-all" data-value="${opt}">
        ${opt}
      </div>
    `).join('');

    optionsList.querySelectorAll('[data-value]').forEach(item => {
      item.onclick = (e) => {
        e.stopPropagation();
        const val = item.getAttribute('data-value');

        label.textContent = val;
        label.classList.remove('text-zinc-400', 'italic');
        label.classList.add('text-white');

        closeAllSelects();
        onSelect(val);
      };
    });
  }

  function collectPersonalization({ requireAll }) {
    const inputs = document.querySelectorAll('[data-personalization-key]');
    const out = {};
    let anyFilled = false;

    for (const i of inputs) {
      const key = i.getAttribute('data-personalization-key');
      const val = (i.value || '').trim();
      if (val) anyFilled = true;
      if (requireAll && !val) return { ok: false, personalization: null };
      if (val) out[key] = val;
    }
    if (!anyFilled) return { ok: false, personalization: null };
    return { ok: true, personalization: out };
  }

  function updatePriceUI() {
    if (!selectedVariant) return;
    if (typeof selectedVariant.price === 'number' || typeof selectedVariant.price === 'string') {
      const p = Number(selectedVariant.price);
      if (!Number.isNaN(p)) {
        priceValue.innerHTML = `${p.toFixed(2)} <span class="text-xs md:text-sm not-italic uppercase opacity-40">€</span>`;
      }
    }
  }

  function setHint(text) {
    if (helperHint) helperHint.textContent = text;
  }

  function setPreviewLoading(isLoading) {
    if (isLoading) {
      previewSpinner.classList.remove('hidden');
      previewBadge.classList.add('hidden');
    } else {
      previewSpinner.classList.add('hidden');
    }
  }

  // ===== Gallery (wrap-around + premium transition) =====

  function setActiveThumb(idx) {
    thumbs.forEach((b, i) => {
      b.classList.toggle('ring-2', i === idx);
      b.classList.toggle('ring-white/30', i === idx);
      b.classList.toggle('bg-white/10', i === idx);
    });

    const active = thumbs[idx];
    if (active) active.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
  }

async function setMainImageAnimated(url, { isPreview = false } = {}) {
  if (!mainImg || !url) return;
  if (galleryLocked) return;

  galleryLocked = true;

  try {
    // Если это не превью, значит юзер листает фотки и "выходит" из Live Preview
    if (!isPreview) {
      previewPublicUrl = null;
      previewBadge?.classList.add('hidden');
    }

    // leave
    mainImg.classList.add('gallery-leave');
    sheen?.classList.add('sheen-on');
    await sleep(140);

    // swap
    const prevSrc = mainImg.src;
    mainImg.src = url;

    // wait load (чтобы не моргало)
    if (!mainImg.complete || mainImg.naturalWidth === 0) {
      await new Promise((resolve) => {
        const done = () => {
          mainImg.onload = null;
          mainImg.onerror = null;
          resolve();
        };
        mainImg.onload = done;
        mainImg.onerror = () => {
          // если не загрузилось — откатимся обратно
          if (prevSrc) mainImg.src = prevSrc;
          done();
        };
      });
    }

    // enter
    mainImg.classList.remove('gallery-leave');
    mainImg.classList.add('gallery-enter');
    await sleep(520);

  } finally {
    sheen?.classList.remove('sheen-on');
    mainImg.classList.remove('gallery-enter');
    galleryLocked = false;
  }
}
  let pendingGalleryIndex = null;

function wrapIndex(i, len) {
  if (!len) return 0;
  return (i % len + len) % len;
}

async function goToIndex(nextIdx) {
  if (!thumbs.length) return;

  // если анимация идёт — не игнорим клик, а запоминаем "куда хотели"
  if (galleryLocked) {
    pendingGalleryIndex = nextIdx;
    return;
  }

  galleryIndex = wrapIndex(nextIdx, thumbs.length);
  const src = thumbs[galleryIndex].dataset.src;

  setActiveThumb(galleryIndex);
  await setMainImageAnimated(src, { isPreview: false });

  // если пока крутилась анимация — были клики, прыгаем в последний
  if (pendingGalleryIndex !== null) {
    const last = pendingGalleryIndex;
    pendingGalleryIndex = null;
    await goToIndex(last);
  }
}

  // init
  (function initGallery() {
    if (!thumbs.length) return;
    // если mainImg уже не равен первой — всё равно начнём с 0
    setActiveThumb(0);
    galleryIndex = 0;

    thumbs.forEach((btn, i) => btn.addEventListener('click', () => goToIndex(i)));
    prevBtn?.addEventListener('click', () => goToIndex(galleryIndex - 1));
    nextBtn?.addEventListener('click', () => goToIndex(galleryIndex + 1));
  })();

  // ===== Preview generation  =====
  async function fetchPreviewNow({ force = false } = {}) {
    if (!selectedVariant) return;

    const p = collectPersonalization({ requireAll: false });
    if (!p.ok) {
      if (force) notify('Fill at least one field', true);
      return;
    }

    try { previewAbort?.abort(); } catch (e) {}
    previewAbort = new AbortController();

    setPreviewLoading(true);
    previewPublicUrl = null;

    try {
      const res = await fetch('/api/mockups/preview', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        signal: previewAbort.signal,
        body: JSON.stringify({
          product_slug: productSlug,
          variant_id: selectedVariant.id,
          personalization: p.personalization
        })
      });

      previewPublicUrl = res.headers.get("X-Preview-Url");

      const blob = await res.blob();
      const url = URL.createObjectURL(blob);

      // премиум-переход как у галереи
      await setMainImageAnimated(url, {isPreview:true});

      setPreviewLoading(false);
      previewBadge.classList.remove('hidden');
      setHint('Preview generated · ready to add to bag');
      setTimeout(scrollToPreview, 300);

    } catch (e) {
      if (e.name !== 'AbortError') {
        setPreviewLoading(false);
        if (force) notify('Preview error', true);
      }
    }
  }

// ===== Model sorting helpers =====

function normalizeModelName(s) {
  return String(s || '').trim().toLowerCase();
}

function parseModel(s) {
  const t = normalizeModelName(s);

  // Вытащим номер поколения (16, 17, 23 и т.д.)
  const numMatch = t.match(/\b(\d{1,2})\b/);
  const num = numMatch ? Number(numMatch[1]) : -1;

  // Приоритет версии
  let tier = 0;
  if (/\bultra\b/.test(t)) tier = 50;
  else if (/\bpro\s*max\b/.test(t)) tier = 45;
  else if (/\bpro\b/.test(t)) tier = 40;
  else if (/\bplus\b/.test(t)) tier = 30;
  else if (/\bedge\b/.test(t)) tier = 25;
  else if (/\bair\b/.test(t)) tier = 20;
  else tier = 10; // базовая версия

  return { num, tier };
}

function modelCompare(a, b) {
  const A = parseModel(a);
  const B = parseModel(b);

  // 1. Сначала по поколению (больше выше)
  if (A.num !== B.num) return B.num - A.num;

  // 2. Потом по версии (Pro/Ultra выше)
  if (A.tier !== B.tier) return B.tier - A.tier;

  // 3. Потом алфавит
  return normalizeModelName(a).localeCompare(normalizeModelName(b));
}


// ===== Brand → Model logic =====

const brands = [...new Set(variants.map(v => v.brand))].sort();

initCustomSelect('brandCustomSelect', brands, (brand) => {

  selectedBrand = brand;
  selectedModel = null;
  selectedVariant = null;
  previewPublicUrl = null;

  setHint('Select your model to generate preview');

  const wrap = document.getElementById('modelWrap');
  wrap.classList.remove('opacity-20', 'pointer-events-none');

  const models = variants
    .filter(v => v.brand === brand)
    .map(v => v.model);

  const uniqueSortedModels = [...new Set(models)].sort(modelCompare);

  initCustomSelect('modelCustomSelect', uniqueSortedModels, (model) => {

    selectedModel = model;

    selectedVariant = variants.find(
      v => v.brand === selectedBrand && v.model === selectedModel
    );

    updatePriceUI();
    setHint('Type personalization to generate preview');
    fetchPreviewNow();
  });

});


  document.querySelectorAll('[data-personalization-key]').forEach(inp => {
    inp.addEventListener('input', () => {
      clearTimeout(previewTimer);
      previewTimer = setTimeout(() => {
        if (!selectedVariant) return;
        setHint('Generating preview…');
        fetchPreviewNow();
      }, 1100);
    });
  });

  function notify(msg, isError = false) {
  const toast = document.getElementById('cartToast');
  const m = document.getElementById('toastMessage');
  const viewBagLink = toast.querySelector('a[href="/cart"]'); // Находим ссылку на корзину

  m.textContent = msg;

  // Меняем цвет текста в зависимости от типа сообщения
  m.className = isError
    ? 'text-[10px] font-black uppercase tracking-[0.2em] text-red-500'
    : 'text-[10px] font-black uppercase tracking-[0.2em] text-black';

  // Логика: если сообщение не про корзину, скрываем ссылку "View Bag"
  if (viewBagLink) {
    if (msg.toLowerCase().includes('bag') || msg.toLowerCase().includes('корзин')) {
      viewBagLink.style.display = 'block';
    } else {
      viewBagLink.style.display = 'none';
    }
  }

  toast.classList.remove('opacity-0', 'translate-y-8', 'pointer-events-none');
  setTimeout(() => {
    toast.classList.add('opacity-0', 'translate-y-8', 'pointer-events-none');
  }, 3000);
}

  document.getElementById('addToCartBtn').onclick = async () => {
    if (!selectedVariant) {
      setHint('Select device model to continue');
      return notify('Select Device', true);
    }

    const p = collectPersonalization({ requireAll: true });
    if (!p.ok) {
      setHint('Fill all personalization fields');
      return notify('Check Fields', true);
    }

    const btn = document.getElementById('addToCartBtn');
    btn.disabled = true;
    const original = btn.innerHTML;
    btn.innerHTML = '<span class="text-black text-[11px] font-bold uppercase tracking-[0.5em] animate-pulse">Wait...</span>';

    try {
      if (!previewPublicUrl) {
        setHint('Generating preview…');
        await fetchPreviewNow({ force: true });
      }

      let attempts = 0;
      while (!previewPublicUrl && attempts < 15) {
        await sleep(120);
        attempts++;
      }

      const res = await fetch('/api/cart/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          product_id: {{ product.id }},
          variant_id: selectedVariant.id,
          qty: 1,
          personalization: p.personalization,
          preview_url: previewPublicUrl
        })
      });

      if (res.ok) {
        const cart = await res.json().catch(() => null)
        window.dispatchEvent(new CustomEvent("cart:updated", { detail: cart }))
        setHint('Added to bag · you can checkout anytime');
        notify('Added to bag');
      } else {
        setHint('Could not add to bag');
        notify('Error', true);
      }

    } catch (e) {
      setHint('Could not add to bag');
      notify('Error', true);
    } finally {
      btn.disabled = false;
      btn.innerHTML = original;
    }
  };

  setHint('Select device model to generate preview');


let currentHems = { lat: 'N', lng: 'W' };

function toggleHem(type, val) {
    currentHems[type] = val;

    // Сбрасываем все кнопки в группе
    document.querySelectorAll(`[id^="btn-${type}-"]`).forEach(btn => {
        btn.classList.remove('active');
    });

    // Активируем нужную
    const activeBtn = document.getElementById(`btn-${type}-${val}`);
    if (activeBtn) activeBtn.classList.add('active');

    syncCoords();
}

function syncCoords() {
    const lat = document.getElementById('latInput')?.value || '0.0000';
    const lng = document.getElementById('lngInput')?.value || '0.0000';
    const final = `${lat}° ${currentHems.lat}\n${lng}° ${currentHems.lng}`;

    const hidden = document.getElementById('finalCoords');
    if (hidden) {
        hidden.value = final;
        // Запускаем обновление превью
        if (typeof fetchPreviewNow === 'function' && selectedVariant) {
            fetchPreviewNow();
        }
    }
}

// Слушаем изменения в цифрах
document.addEventListener('input', (e) => {
    if (e.target.id === 'latInput' || e.target.id === 'lngInput') {
        syncCoords();
    }
});

// Инициализация при загрузке
document.addEventListener('DOMContentLoaded', () => {
    if (document.getElementById('coordsWidget')) {
        toggleHem('lat', 'N');
        toggleHem('lng', 'W');
    }
});

    let autocomplete;

function initAutocomplete() {
  const input = document.getElementById('locationSearch');
  if (!input) return;

  // Настраиваем поиск только на города и адреса (чтобы экономить токены)
  const options = {
    fields: ["geometry", "name"],
    types: ["geocode"],
  };

  autocomplete = new google.maps.places.Autocomplete(input, options);

  // Когда пользователь выбирает место из списка
  autocomplete.addListener("place_changed", () => {
    const place = autocomplete.getPlace();

    if (!place.geometry || !place.geometry.location) {
      console.error("Место не найдено");
      return;
    }

    const lat = place.geometry.location.lat();
    const lng = place.geometry.location.lng();

    // 1. Устанавливаем полушария
    toggleHem('lat', lat >= 0 ? 'N' : 'S');
    toggleHem('lng', lng >= 0 ? 'E' : 'W');

    // 2. Заполняем поля абсолютными значениями (без минусов)
    document.getElementById('latInput').value = Math.abs(lat).toFixed(4);
    document.getElementById('lngInput').value = Math.abs(lng).toFixed(4);

    // 3. Синхронизируем для превью
    syncCoords();
  });
}

// Запускаем инициализацию при загрузке страницы
document.addEventListener('DOMContentLoaded', () => {
  // Проверяем, загрузился ли скрипт Google
  if (typeof google !== 'undefined') {
    initAutocomplete();
  }
});

    function getCurrentLocation() {
    if (!navigator.geolocation) {
        notify('Геолокация не поддерживается вашим браузером', true);
        return;
    }

    // Добавляем визуальный фидбек на кнопку, пока ищем
    const btn = document.querySelector('button[onclick="getCurrentLocation()"]');
    const originalIcon = btn.innerHTML;
    btn.classList.add('animate-pulse');

    navigator.geolocation.getCurrentPosition(
        (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            // 1. Устанавливаем полушария (N/S, E/W)
            toggleHem('lat', lat >= 0 ? 'N' : 'S');
            toggleHem('lng', lng >= 0 ? 'E' : 'W');

            // 2. Заполняем инпуты абсолютными значениями
            const latInput = document.getElementById('latInput');
            const lngInput = document.getElementById('lngInput');

            if (latInput && lngInput) {
                latInput.value = Math.abs(lat).toFixed(4);
                lngInput.value = Math.abs(lng).toFixed(4);
            }

            // 3. Синхронизируем для скрытого поля и вызываем превью
            syncCoords();

            // Очищаем поле поиска адреса, так как мы юзаем координаты напрямую
            const searchInput = document.getElementById('locationSearch');
            if (searchInput) searchInput.value = "Current Location";

            btn.classList.remove('animate-pulse');
            notify('Coordinates updated');
        },
        (error) => {
            btn.classList.remove('animate-pulse');
            console.error("Geolocation error:", error);
            notify('Coordinates update error', true);
        },
        {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
        }
    );
}

    function scrollToPreview() {
    // Проверяем, что это мобилка (ширина экрана меньше 1024px)
    if (window.innerWidth < 1024) {
        const previewElement = document.getElementById('product-preview');
        if (previewElement) {
            previewElement.scrollIntoView({
                behavior: 'smooth', // Плавный скролл в стиле Noirid
                block: 'start'      // Прижать верх превью к верху экрана
            });
        }
    }
}
</script>

<style>
.coord-btn {
  width: 42px;
  height: 42px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 10px;
  font-size: 12px;
  font-weight: 700;
  color: #52525b; /* zinc-600 */
  transition: all 0.2s ease;
}

.coord-btn.active {
  background: rgba(255, 255, 255, 0.1);
  color: #ffffff !important;
}

/* Скрываем стрелки у числового поля */
input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
  /* Premium transitions for main image */
  .gallery-img {
    will-change: transform, opacity, filter;
    transition:
      opacity 380ms ease,
      filter 520ms ease,
      transform 900ms cubic-bezier(0.16, 1, 0.3, 1);
  }

  .gallery-leave {
    opacity: 0;
    filter: blur(7px);
    transform: scale(1.03);
  }

  .gallery-enter {
    opacity: 1;
    filter: blur(0);
    transform: scale(1);
  }

  .sheen-on { opacity: 1; }

  input::placeholder { transition: color 0.3s; }
  input:focus::placeholder { color: transparent; }
</style>
{% endblock %}
