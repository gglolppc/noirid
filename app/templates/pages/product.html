{% extends "base.html" %}

{% block title %}{{ product.title }} · NOIRID{% endblock %}

{% block content %}
<div class="relative bg-[#050505] selection:bg-white selection:text-black min-h-screen">
  <section class="pt-32 pb-24 px-6 md:px-12">
    <div class="mx-auto max-w-6xl w-full">

      <div class="reveal">
        <div class="text-[10px] uppercase tracking-[0.5em] text-zinc-500 font-medium">Design / Detail</div>
        <h1 class="mt-6 text-6xl md:text-8xl font-bold uppercase tracking-[-0.05em] text-white leading-[0.85]">
          {{ product.title }}
        </h1>
        <div class="mt-8 flex items-center justify-between border-b border-white/10 pb-6">
          <p class="text-sm md:text-base text-zinc-400 font-light max-w-xl leading-relaxed">
            {{ product.description or "Limited edition design. Engineered for a perfect fit and minimalist aesthetic." }}
          </p>
          <div class="text-right">
             <div class="text-[10px] uppercase tracking-[0.2em] text-zinc-500 mb-1">Base Price</div>
             <div class="text-3xl font-light text-white italic tracking-tight">
               {{ "%.2f"|format(product.base_price) }} <span class="text-sm font-normal text-zinc-500 not-italic uppercase">{{ product.currency }}</span>
             </div>
          </div>
        </div>
      </div>

      <div class="mt-16 grid grid-cols-1 lg:grid-cols-2 gap-16 lg:gap-24">
        <div class="reveal reveal-delay-1">
          <div class="relative aspect-[4/5] rounded-[40px] border border-white/10 bg-[#0A0A0A] overflow-hidden group">
            <div class="pointer-events-none absolute inset-0 z-10 shadow-[inset_0_0_100px_rgba(0,0,0,0.5)]"></div>

            <div id="previewBadge" class="hidden absolute top-6 left-6 z-20 rounded-full bg-white/10 backdrop-blur px-4 py-2 text-[10px] uppercase tracking-[0.3em] text-white/80 border border-white/10">
              Preview
            </div>

            <div id="previewSpinner" class="hidden absolute inset-0 z-20 items-center justify-center pointer-events-none">
              <div class="rounded-full border border-white/20 bg-black/40 backdrop-blur px-6 py-4 text-[10px] uppercase tracking-[0.4em] text-white/80">
                Rendering…
              </div>
            </div>

            <div id="productGallery" class="flex h-full w-full overflow-x-auto snap-x snap-mandatory scroll-smooth no-scrollbar">
              <div class="h-full w-full flex-none snap-center flex items-center justify-center p-12 md:p-20">
                {% if product.images %}
                  <img src="{{ product.images[0].url }}" alt="{{ product.title }}" class="gallery-img h-full w-full object-contain transition-transform duration-700 group-hover:scale-105" />
                {% else %}
                  <img id="mainProductImg" src="/static/img/placeholder.webp" alt="{{ product.title }}" class="gallery-img h-full w-full object-contain transition-transform duration-700 group-hover:scale-105" />
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <div class="reveal reveal-delay-2 flex flex-col justify-center">
          <div class="space-y-10">
            {% set personalization_schema = product.personalization_schema or {} %}
            {% set personalization_count = personalization_schema|length %}

            {% for key, limit in personalization_schema.items()|sort %}
              {% set limit_value = limit.max_len if limit is mapping and limit.max_len is defined else limit %}
              <div class="group relative">
                <label class="text-[10px] uppercase tracking-[0.3em] text-zinc-500 group-focus-within:text-zinc-200 transition-colors">
                  {{ "%02d"|format(loop.index) }}. Type your {{ key }}
                </label>
                <input type="text"
                       class="mt-2 w-full bg-transparent border-b border-white/10 py-4 text-xl text-white placeholder:text-zinc-800 focus:outline-none focus:border-white/40 transition-all duration-300 font-light"
                       placeholder="Type your {{ key }}" autocomplete="off"
                       data-personalization-key="{{ key }}"
                       data-personalization-max="{{ limit_value }}"
                       maxlength="{{ limit_value }}">
              </div>
            {% endfor %}

            <div class="group relative">
              <label class="text-[10px] uppercase tracking-[0.3em] text-zinc-500">
                {{ "%02d"|format(personalization_count + 1) }}. Device Brand
              </label>
              <div id="brandCustomSelect" class="custom-select relative mt-2">
                <div class="select-trigger w-full border-b border-white/10 py-4 text-xl text-white font-light cursor-pointer flex justify-between items-center hover:border-white/30 transition-all">
                  <span class="selected-value text-zinc-600">Select Brand</span>
                  <span class="arrow text-[10px] transition-transform duration-300">↓</span>
                </div>
                <div class="select-options absolute top-full left-0 w-full z-30 mt-2 bg-zinc-900/90 backdrop-blur-xl border border-white/10 rounded-2xl overflow-hidden opacity-0 invisible transition-all duration-200 translate-y-2">
                </div>
              </div>
            </div>

            <div id="modelWrap" class="group relative hidden opacity-0 transition-all duration-500">
              <label class="text-[10px] uppercase tracking-[0.3em] text-zinc-500">
                {{ "%02d"|format(personalization_count + 2) }}. Device Model
              </label>
              <div id="modelCustomSelect" class="custom-select relative mt-2">
                <div class="select-trigger w-full border-b border-white/10 py-4 text-xl text-white font-light cursor-pointer flex justify-between items-center hover:border-white/30 transition-all">
                  <span class="selected-value text-zinc-600">Select Model</span>
                  <span class="arrow text-[10px] transition-transform duration-300">↓</span>
                </div>
                <div class="select-options absolute top-full left-0 w-full z-30 mt-2 bg-zinc-900/90 backdrop-blur-xl border border-white/10 rounded-2xl overflow-hidden opacity-0 invisible transition-all duration-200 translate-y-2">
                </div>
              </div>
            </div>

            <div class="pt-8 space-y-4">
              <button id="addToCartBtn"
                      class="w-full rounded-full bg-white text-black py-6 text-[11px] font-bold uppercase tracking-[0.5em] transition-all hover:bg-zinc-200 active:scale-[0.98] disabled:opacity-50">
                Add To Bag
              </button>
              <div class="flex items-center justify-between px-4">
                <span class="text-[9px] uppercase tracking-[0.2em] text-zinc-600 italic">Limited Edition / Noirid Drop</span>
                <a href="/catalog" class="text-[9px] uppercase tracking-[0.2em] text-zinc-500 hover:text-white transition underline underline-offset-8 decoration-zinc-800 hover:decoration-white">Back to Catalog</a>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<div id="cartToast" class="pointer-events-none fixed bottom-12 left-1/2 -translate-x-1/2 z-50 flex opacity-0 transition-all duration-500 translate-y-10">
  <div class="pointer-events-auto rounded-full bg-white px-8 py-4 flex items-center gap-8 shadow-2xl">
    <div id="toastMessage" class="text-[10px] font-bold uppercase tracking-[0.2em] text-black">Added to selection</div>
    <a id="toastLink" href="/cart" class="text-[10px] font-bold uppercase tracking-[0.2em] text-zinc-500 hover:text-black transition">Open Bag →</a>
  </div>
</div>

<script>
const variants = {{ variants_payload|tojson }};
  const productSlug = {{ product.slug|tojson }};

  let selectedBrand = null;
  let selectedModel = null;
  let selectedVariant = null;

  let previewUrl = null;
  let previewAbort = null;
  let previewTimer = null;

  const previewSpinner = document.getElementById('previewSpinner');
  const previewBadge = document.getElementById('previewBadge');

  // Глобальный клик для закрытия
  document.addEventListener('click', (e) => {
    document.querySelectorAll('.custom-select').forEach(container => {
      if (!container.contains(e.target)) {
        const optionsList = container.querySelector('.select-options');
        const arrow = container.querySelector('.arrow');
        optionsList.classList.add('opacity-0', 'invisible', 'translate-y-2');
        if (arrow) arrow.style.transform = 'rotate(0deg)';
      }
    });
  });

  function initCustomSelect(containerId, options, onSelect) {
    const container = document.getElementById(containerId);
    let trigger = container.querySelector('.select-trigger');
    const optionsList = container.querySelector('.select-options');

    // Очистка старых слушателей через замену элемента
    const newTrigger = trigger.cloneNode(true);
    trigger.parentNode.replaceChild(newTrigger, trigger);
    trigger = newTrigger; // Теперь работаем с актуальным триггером

    const label = trigger.querySelector('.selected-value');
    const arrow = trigger.querySelector('.arrow');

    trigger.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = !optionsList.classList.contains('opacity-0');

      document.querySelectorAll('.select-options').forEach(el => {
        if (el !== optionsList) el.classList.add('opacity-0', 'invisible', 'translate-y-2');
      });

      if (!isOpen) {
        optionsList.classList.remove('opacity-0', 'invisible', 'translate-y-2');
        arrow.style.transform = 'rotate(180deg)';
      } else {
        optionsList.classList.add('opacity-0', 'invisible', 'translate-y-2');
        arrow.style.transform = 'rotate(0deg)';
      }
    });

    optionsList.innerHTML = options.map(opt => `
      <div class="px-6 py-4 text-white hover:bg-white hover:text-black cursor-pointer text-sm transition-all duration-200" data-value="${opt}">${opt}</div>
    `).join('');

    optionsList.querySelectorAll('[data-value]').forEach(item => {
      item.onclick = () => {
        const val = item.getAttribute('data-value');

        // Обновляем текст в актуальном триггере
        label.textContent = val;
        label.classList.remove('text-zinc-600');
        label.classList.add('text-white');

        optionsList.classList.add('opacity-0', 'invisible', 'translate-y-2');
        arrow.style.transform = 'rotate(0deg)';
        onSelect(val);
      };
    });
  }

  // --- Preview Logic ---
  function setPreviewLoading(isLoading) {
    if (isLoading) {
      previewSpinner.classList.remove('hidden');
      previewSpinner.classList.add('flex');
    } else {
      previewSpinner.classList.add('hidden');
      previewSpinner.classList.remove('flex');
    }
  }

  function updateGalleryMainImage(newUrl) {
    const firstImg = document.querySelector('#productGallery .gallery-img');
    if (!firstImg) return;
    if (previewUrl) URL.revokeObjectURL(previewUrl);
    previewUrl = newUrl;
    firstImg.src = newUrl;
    previewBadge.classList.remove('hidden');
  }

  async function fetchPreviewNow() {
    if (!selectedVariant?.id) return;
    const p = collectPersonalization();
    if (!p.ok) return;

    const startTime = Date.now();
    const MIN_LOAD_TIME = 1000;

    try { previewAbort?.abort(); } catch (e) {}
    previewAbort = new AbortController();

    setPreviewLoading(true);

    try {
      const res = await fetch('/api/mockups/preview', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        signal: previewAbort.signal,
        body: JSON.stringify({
          product_slug: productSlug,
          variant_id: selectedVariant.id,
          personalization: p.personalization
        })
      });

      if (!res.ok) throw new Error("render_error");

      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const remaining = Math.max(0, MIN_LOAD_TIME - (Date.now() - startTime));

      setTimeout(() => {
        updateGalleryMainImage(url);
        setPreviewLoading(false);
      }, remaining);

    } catch (e) {
      if (e.name !== 'AbortError') setPreviewLoading(false);
    }
  }

  function debouncePreview(ms = 800) {
    clearTimeout(previewTimer);
    previewTimer = setTimeout(fetchPreviewNow, ms);
  }

  // --- Initialization ---
  const brands = [...new Set(variants.map(v => v.brand))].sort();

  initCustomSelect('brandCustomSelect', brands, (brand) => {
    selectedBrand = brand;
    selectedModel = null;
    selectedVariant = null;

    // Сброс визуального состояния модели
    const modelContainer = document.getElementById('modelCustomSelect');
    const modelLabel = modelContainer.querySelector('.selected-value');
    modelLabel.textContent = 'Select Model';
    modelLabel.classList.add('text-zinc-600');
    modelLabel.classList.remove('text-white');

    const modelWrap = document.getElementById('modelWrap');
    const models = variants.filter(v => v.brand === brand).map(v => v.model);

    initCustomSelect('modelCustomSelect', [...new Set(models)].sort(), (model) => {
      selectedModel = model;
      selectedVariant = variants.find(v => v.brand === selectedBrand && v.model === selectedModel);
      fetchPreviewNow();
    });

    modelWrap.classList.remove('hidden');
    setTimeout(() => modelWrap.classList.remove('opacity-0'), 10);
  });

  document.querySelectorAll('[data-personalization-key]').forEach(inp => {
    inp.addEventListener('input', () => {
      if (selectedVariant) debouncePreview(800);
    });
  });

  function collectPersonalization() {
    const personalization = {};
    const inputs = document.querySelectorAll('[data-personalization-key]');
    for (const input of inputs) {
      const key = input.getAttribute('data-personalization-key');
      const val = input.value.trim();
      if (!val) return { ok: false };
      personalization[key] = val;
    }
    return { ok: true, personalization };
  }

  function notify(msg, isError = false) {
    const toast = document.getElementById('cartToast');
    const text = document.getElementById('toastMessage');
    text.textContent = msg;
    toast.querySelector('div').style.backgroundColor = isError ? '#111' : 'white';
    toast.querySelector('div').style.border = isError ? '1px solid #333' : 'none';
    text.style.color = isError ? 'white' : 'black';
    document.getElementById('toastLink').style.display = isError ? 'none' : 'block';
    toast.classList.remove('opacity-0', 'translate-y-10');
    setTimeout(() => toast.classList.add('opacity-0', 'translate-y-10'), 4000);
  }

  document.getElementById('addToCartBtn').addEventListener('click', async () => {
    if (!selectedVariant) return notify('Select Device', true);
    const p = collectPersonalization();
    if (!p.ok) return notify('Fill personalization', true);

    const btn = document.getElementById('addToCartBtn');
    btn.disabled = true;

    try {
      const res = await fetch('/api/cart/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          product_id: {{ product.id }},
          variant_id: selectedVariant.id,
          qty: 1,
          personalization: p.personalization
        })
      });
      if (res.ok) notify('Added to bag');
      else notify('Error adding to bag', true);
    } catch (e) {
      notify('Error', true);
    } finally {
      btn.disabled = false;
    }
  });
</script>

<style>
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  input:focus { box-shadow: none !important; outline: none !important; }
  .select-options { max-height: 250px; overflow-y: auto; }
</style>
{% endblock %}